name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    branches: [main, p10-sast-secrets]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SEMGREP_VERSION: "1.95.0"
  GITLEAKS_VERSION: "8.21.2"

jobs:
  sast_secrets:
    name: SAST & Secrets Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        timeout-minutes: 2
        with:
          fetch-depth: 0  # Full history for Gitleaks

      - name: Ensure evidence directories
        run: mkdir -p EVIDENCE/P10

      # ============================================
      # C1: SAST with Semgrep (SARIF output)
      # ============================================
      - name: Run Semgrep SAST
        timeout-minutes: 8
        run: |
          echo "::group::Running Semgrep ${{ env.SEMGREP_VERSION }}"
          
          # Run Semgrep with p/ci profile + custom rules
          docker run --rm -v $PWD:/src \
            returntocorp/semgrep:${{ env.SEMGREP_VERSION }} \
            semgrep ci \
              --config p/ci \
              --config p/security-audit \
              --config /src/security/semgrep/rules.yml \
              --sarif \
              --output /src/EVIDENCE/P10/semgrep.sarif \
              --metrics=off \
              --verbose || true
          
          echo "::endgroup::"
          
          # Parse results for summary
          if [ -f EVIDENCE/P10/semgrep.sarif ]; then
            echo "### Semgrep SAST Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count findings by severity
            CRITICAL=$(jq '[.runs[].results[] | select(.level == "error")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo 0)
            WARNING=$(jq '[.runs[].results[] | select(.level == "warning")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo 0)
            NOTE=$(jq '[.runs[].results[] | select(.level == "note")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo 0)
            TOTAL=$(jq '[.runs[].results[]] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo 0)
            
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Error | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Warning | $WARNING |" >> $GITHUB_STEP_SUMMARY
            echo "| Note | $NOTE |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # List top findings
            if [ "$TOTAL" -gt 0 ]; then
              echo "#### Top Findings:" >> $GITHUB_STEP_SUMMARY
              jq -r '.runs[].results[] | "- [\(.level | ascii_upcase)] \(.ruleId): \(.message.text)" | .[0:200]' \
                EVIDENCE/P10/semgrep.sarif 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || true
            fi
          else
            echo "âš ï¸ Semgrep SARIF not generated" >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # C2: Secrets scanning with Gitleaks
      # ============================================
      - name: Run Gitleaks secrets scan
        timeout-minutes: 5
        run: |
          echo "::group::Running Gitleaks ${{ env.GITLEAKS_VERSION }}"
          
          # Run Gitleaks on current source
          docker run --rm -v $PWD:/repo \
            zricethezav/gitleaks:v${{ env.GITLEAKS_VERSION }} \
            detect \
              --no-banner \
              --config=/repo/security/.gitleaks.toml \
              --source=/repo \
              --report-format=json \
              --report-path=/repo/EVIDENCE/P10/gitleaks.json \
              --verbose || true
          
          echo "::endgroup::"
          
          # Parse results for summary
          if [ -f EVIDENCE/P10/gitleaks.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Gitleaks Secrets Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            SECRETS_COUNT=$(jq 'length' EVIDENCE/P10/gitleaks.json 2>/dev/null || echo 0)
            
            if [ "$SECRETS_COUNT" -gt 0 ]; then
              echo "âš ï¸ **Found $SECRETS_COUNT potential secret(s)**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| File | Rule | Line |" >> $GITHUB_STEP_SUMMARY
              echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.[] | "| \(.File) | \(.RuleID) | \(.StartLine) |"' \
                EVIDENCE/P10/gitleaks.json 2>/dev/null | head -10 >> $GITHUB_STEP_SUMMARY || true
            else
              echo "âœ… No secrets detected" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Gitleaks report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # C3: Generate summary markdown
      # ============================================
      - name: Generate SAST summary
        timeout-minutes: 2
        run: |
          cat > EVIDENCE/P10/sast_summary.md << 'HEADER'
          # SAST & Secrets Scan Summary
          
          **Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Tools:** Semgrep ${{ env.SEMGREP_VERSION }} + Gitleaks ${{ env.GITLEAKS_VERSION }}
          
          ## Semgrep SAST Results
          
          HEADER
          
          if [ -f EVIDENCE/P10/semgrep.sarif ]; then
            TOTAL=$(jq '[.runs[].results[]] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo 0)
            CRITICAL=$(jq '[.runs[].results[] | select(.level == "error")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo 0)
            WARNING=$(jq '[.runs[].results[] | select(.level == "warning")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo 0)
            
            echo "**Total findings:** $TOTAL" >> EVIDENCE/P10/sast_summary.md
            echo "" >> EVIDENCE/P10/sast_summary.md
            echo "| Severity | Count |" >> EVIDENCE/P10/sast_summary.md
            echo "|----------|-------|" >> EVIDENCE/P10/sast_summary.md
            echo "| Error | $CRITICAL |" >> EVIDENCE/P10/sast_summary.md
            echo "| Warning | $WARNING |" >> EVIDENCE/P10/sast_summary.md
            echo "" >> EVIDENCE/P10/sast_summary.md
            
            if [ "$TOTAL" -gt 0 ]; then
              echo "### Key Findings:" >> EVIDENCE/P10/sast_summary.md
              jq -r '.runs[].results[] | "- **\(.ruleId)** (\(.level)): \(.message.text | .[0:100])..."' \
                EVIDENCE/P10/semgrep.sarif 2>/dev/null | head -15 >> EVIDENCE/P10/sast_summary.md || true
            fi
          fi
          
          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "## Gitleaks Secrets Scan Results" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          
          if [ -f EVIDENCE/P10/gitleaks.json ]; then
            SECRETS=$(jq 'length' EVIDENCE/P10/gitleaks.json 2>/dev/null || echo 0)
            echo "**Potential secrets found:** $SECRETS" >> EVIDENCE/P10/sast_summary.md
            
            if [ "$SECRETS" -gt 0 ]; then
              echo "" >> EVIDENCE/P10/sast_summary.md
              echo "### Detected Secrets:" >> EVIDENCE/P10/sast_summary.md
              jq -r '.[] | "- **\(.RuleID)** in `\(.File):\(.StartLine)`"' \
                EVIDENCE/P10/gitleaks.json 2>/dev/null | head -10 >> EVIDENCE/P10/sast_summary.md || true
            fi
          fi
          
          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "## Action Items" >> EVIDENCE/P10/sast_summary.md
          echo "" >> EVIDENCE/P10/sast_summary.md
          echo "1. Review all Error-level findings from Semgrep" >> EVIDENCE/P10/sast_summary.md
          echo "2. Investigate any detected secrets" >> EVIDENCE/P10/sast_summary.md
          echo "3. Add false positives to allowlists" >> EVIDENCE/P10/sast_summary.md
          echo "4. Create issues for legitimate findings" >> EVIDENCE/P10/sast_summary.md

      # ============================================
      # C3: Upload artifacts
      # ============================================
      - name: Upload SAST & Secrets evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: P10_EVIDENCE
          path: EVIDENCE/P10/
          retention-days: 30

      # ============================================
      # Summary
      # ============================================
      - name: Job Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`EVIDENCE/P10/semgrep.sarif\` - Semgrep SAST report (SARIF format)" >> $GITHUB_STEP_SUMMARY
          echo "- \`EVIDENCE/P10/gitleaks.json\` - Gitleaks secrets scan report" >> $GITHUB_STEP_SUMMARY
          echo "- \`EVIDENCE/P10/sast_summary.md\` - Human-readable summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download artifacts from the Actions run page" >> $GITHUB_STEP_SUMMARY

