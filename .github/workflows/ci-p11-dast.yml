name: Security - DAST (OWASP ZAP)

on:
  workflow_dispatch:
  push:
    branches: [main, p11-dast-zap]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Application settings
  APP_HOST: "0.0.0.0"
  APP_PORT: "8000"
  HEALTH_ENDPOINT: "/health"
  # ZAP settings
  ZAP_VERSION: "stable"
  SCAN_TIMEOUT: "300"

jobs:
  dast_scan:
    name: DAST with OWASP ZAP
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        timeout-minutes: 2

      - name: Ensure evidence directories
        run: mkdir -p EVIDENCE/P11

      # ============================================
      # C1: Setup and run application
      # ============================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
        timeout-minutes: 3

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-dast-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-dast-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        timeout-minutes: 5
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -r requirements.txt

      - name: Start application in background
        timeout-minutes: 2
        run: |
          echo "::group::Starting FastAPI application"
          nohup uvicorn app.main:app \
            --host ${{ env.APP_HOST }} \
            --port ${{ env.APP_PORT }} \
            --log-level info \
            > app.log 2>&1 &
          
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          echo "Application started with PID: $APP_PID"
          echo "::endgroup::"

      - name: Wait for application ready
        timeout-minutes: 2
        run: |
          echo "::group::Waiting for application health check"
          TARGET_URL="http://localhost:${{ env.APP_PORT }}${{ env.HEALTH_ENDPOINT }}"
          echo "Target URL: $TARGET_URL"
          
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf "$TARGET_URL" > /dev/null 2>&1; then
              echo "âœ… Application is ready!"
              curl -v "$TARGET_URL"
              echo "::endgroup::"
              exit 0
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting..."
            sleep 2
          done
          
          echo "âŒ Application failed to start within timeout"
          echo "::group::Application logs"
          cat app.log || echo "No logs available"
          echo "::endgroup::"
          exit 1

      # ============================================
      # C2: Run OWASP ZAP baseline scan
      # ============================================
      - name: Run OWASP ZAP Baseline Scan
        timeout-minutes: 10
        run: |
          echo "::group::Running OWASP ZAP Baseline"
          
          TARGET_URL="http://localhost:${{ env.APP_PORT }}"
          echo "Scanning target: $TARGET_URL"
          
          # Run ZAP baseline scan
          # -t: target URL
          # -r: HTML report
          # -J: JSON report
          # -d: show debug messages
          # -I: ignore warning if no alerts found
          # || true: don't fail CI on findings
          #
          # Note: Using ghcr.io/zaproxy/zaproxy instead of owasp/zap2docker
          
          docker run --rm \
            --network host \
            -v $PWD:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:${{ env.ZAP_VERSION }} \
            zap-baseline.py \
              -t "$TARGET_URL" \
              -r zap_baseline.html \
              -J zap_baseline.json \
              -d \
              -I || true
          
          echo "::endgroup::"
          
          # Move reports to evidence directory
          if [ -f zap_baseline.html ]; then
            mv zap_baseline.html EVIDENCE/P11/
            echo "âœ… HTML report saved"
          fi
          
          if [ -f zap_baseline.json ]; then
            mv zap_baseline.json EVIDENCE/P11/
            echo "âœ… JSON report saved"
          fi

      # ============================================
      # C4: Parse and summarize results
      # ============================================
      - name: Generate DAST summary
        if: always()
        timeout-minutes: 2
        run: |
          cat > EVIDENCE/P11/dast_summary.md << 'HEADER'
          # DAST Scan Summary (OWASP ZAP Baseline)
          
          **Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Tool:** OWASP ZAP (zap-baseline.py)
          **Target:** http://localhost:${{ env.APP_PORT }}
          
          ## Scan Configuration
          
          - **Scan Type:** Baseline (passive scan + spider)
          - **Target URL:** http://localhost:${{ env.APP_PORT }}
          - **Health Check:** ${{ env.HEALTH_ENDPOINT }}
          - **Timeout:** ${{ env.SCAN_TIMEOUT }}s
          
          HEADER
          
          if [ -f EVIDENCE/P11/zap_baseline.json ]; then
            echo "## Findings" >> EVIDENCE/P11/dast_summary.md
            echo "" >> EVIDENCE/P11/dast_summary.md
            
            # Parse JSON for alert counts
            HIGH=$(jq '[.site[].alerts[] | select(.riskdesc | startswith("High"))] | length' EVIDENCE/P11/zap_baseline.json 2>/dev/null || echo 0)
            MEDIUM=$(jq '[.site[].alerts[] | select(.riskdesc | startswith("Medium"))] | length' EVIDENCE/P11/zap_baseline.json 2>/dev/null || echo 0)
            LOW=$(jq '[.site[].alerts[] | select(.riskdesc | startswith("Low"))] | length' EVIDENCE/P11/zap_baseline.json 2>/dev/null || echo 0)
            INFO=$(jq '[.site[].alerts[] | select(.riskdesc | startswith("Informational"))] | length' EVIDENCE/P11/zap_baseline.json 2>/dev/null || echo 0)
            TOTAL=$((HIGH + MEDIUM + LOW + INFO))
            
            echo "| Risk Level | Count |" >> EVIDENCE/P11/dast_summary.md
            echo "|------------|-------|" >> EVIDENCE/P11/dast_summary.md
            echo "| High | $HIGH |" >> EVIDENCE/P11/dast_summary.md
            echo "| Medium | $MEDIUM |" >> EVIDENCE/P11/dast_summary.md
            echo "| Low | $LOW |" >> EVIDENCE/P11/dast_summary.md
            echo "| Informational | $INFO |" >> EVIDENCE/P11/dast_summary.md
            echo "| **Total** | **$TOTAL** |" >> EVIDENCE/P11/dast_summary.md
            echo "" >> EVIDENCE/P11/dast_summary.md
            
            # List alerts
            if [ "$TOTAL" -gt 0 ]; then
              echo "### Alert Details" >> EVIDENCE/P11/dast_summary.md
              echo "" >> EVIDENCE/P11/dast_summary.md
              jq -r '.site[].alerts[] | "#### \(.name) (\(.riskdesc))\n- **CWE:** \(.cweid)\n- **URL:** \(.instances[0].uri // "N/A")\n- **Solution:** \(.solution)\n"' \
                EVIDENCE/P11/zap_baseline.json 2>/dev/null >> EVIDENCE/P11/dast_summary.md || true
            else
              echo "âœ… **No security alerts found**" >> EVIDENCE/P11/dast_summary.md
            fi
            
            # Output to job summary
            echo "### OWASP ZAP Baseline Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Risk Level | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "| Informational | $INFO |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No ZAP report found" >> EVIDENCE/P11/dast_summary.md
            echo "âš ï¸ No ZAP report generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> EVIDENCE/P11/dast_summary.md
          echo "## Action Plan" >> EVIDENCE/P11/dast_summary.md
          echo "" >> EVIDENCE/P11/dast_summary.md
          echo "1. Review HTML report: \`EVIDENCE/P11/zap_baseline.html\`" >> EVIDENCE/P11/dast_summary.md
          echo "2. Triage High/Medium findings" >> EVIDENCE/P11/dast_summary.md
          echo "3. Create Issues for real vulnerabilities" >> EVIDENCE/P11/dast_summary.md
          echo "4. Document false positives" >> EVIDENCE/P11/dast_summary.md

      - name: Stop application
        if: always()
        run: |
          if [ -n "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} 2>/dev/null || true
            echo "Application stopped"
          fi

      # ============================================
      # C3: Upload artifacts
      # ============================================
      - name: Upload DAST evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: P11_EVIDENCE
          path: EVIDENCE/P11/
          retention-days: 30

      - name: Upload application logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: app-logs
          path: app.log
          retention-days: 7

      # ============================================
      # Summary
      # ============================================
      - name: Job Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`EVIDENCE/P11/zap_baseline.html\` - Human-readable ZAP report" >> $GITHUB_STEP_SUMMARY
          echo "- \`EVIDENCE/P11/zap_baseline.json\` - Machine-readable ZAP report" >> $GITHUB_STEP_SUMMARY
          echo "- \`EVIDENCE/P11/dast_summary.md\` - Summary and action plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download artifacts from the Actions run page" >> $GITHUB_STEP_SUMMARY
