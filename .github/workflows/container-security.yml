name: Container Security Scan

on:
  push:
    branches: [ main, feature/** ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan weekly (every Monday at 9 AM)
    - cron: '0 9 * * 1'

jobs:
  hadolint:
    name: Lint Dockerfile with Hadolint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          config: .hadolint.yaml
          format: sarif
          output-file: hadolint-results.sarif
          no-fail: true

      - name: Upload Hadolint results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('hadolint-results.sarif') != ''
        with:
          sarif_file: hadolint-results.sarif
          category: hadolint
        continue-on-error: true

      - name: Upload Hadolint report as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hadolint-report
          path: hadolint-results.sarif
          retention-days: 30

  trivy-scan:
    name: Scan Image with Trivy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t secdev-app:${{ github.sha }} .
          docker tag secdev-app:${{ github.sha }} secdev-app:latest

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: secdev-app:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'  # Don't fail on vulnerabilities (report only)
          ignore-unfixed: false
          trivyignores: .trivyignore

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy

      - name: Run Trivy in table format for readable report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: secdev-app:${{ github.sha }}
          format: 'table'
          output: 'trivy-report.txt'
          severity: 'CRITICAL,HIGH,MEDIUM'
          trivyignores: .trivyignore

      - name: Upload Trivy report as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report
          path: |
            trivy-results.sarif
            trivy-report.txt
          retention-days: 30

      - name: Display Trivy scan summary
        run: |
          echo "=== Trivy Scan Summary ==="
          cat trivy-report.txt
          echo ""
          echo "✅ Trivy scan completed. Review report above for vulnerabilities."

  sbom-generation:
    name: Generate SBOM (Software Bill of Materials)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t secdev-app:${{ github.sha }} .

      - name: Generate SBOM with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: secdev-app:${{ github.sha }}
          format: 'cyclonedx'
          output: 'sbom.json'

      - name: Upload SBOM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

  docker-inspect:
    name: Verify Container Security Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and inspect container
        run: |
          docker build -t secdev-app:test .

          echo "=== Docker Image History ==="
          docker history secdev-app:test

          echo ""
          echo "=== Docker Image Size ==="
          docker images secdev-app:test

          echo ""
          echo "=== Running container for inspection ==="
          docker run -d --name secdev-test secdev-app:test

          sleep 5

          echo ""
          echo "=== Container User Check ==="
          USER_CHECK=$(docker exec secdev-test whoami)
          echo "Running as user: $USER_CHECK"

          if [ "$USER_CHECK" = "root" ]; then
            echo "❌ FAILED: Container is running as root!"
            exit 1
          else
            echo "✅ PASSED: Container is running as non-root user ($USER_CHECK)"
          fi

          echo ""
          echo "=== Container Security Options ==="
          docker inspect secdev-test --format='{{json .HostConfig.SecurityOpt}}' | jq

          echo ""
          echo "=== Container Capabilities ==="
          docker inspect secdev-test --format='{{json .HostConfig.CapDrop}}' | jq
          docker inspect secdev-test --format='{{json .HostConfig.CapAdd}}' | jq

          docker stop secdev-test
          docker rm secdev-test

      - name: Load AppArmor profile
        run: |
          echo "=== Loading AppArmor Profile ==="
          sudo apparmor_parser -r apparmor-profile
          sudo aa-status | grep secdev-app || echo "Profile loaded"

      - name: Test with docker compose (with security profiles)
        run: |
          echo "=== Testing with docker compose ==="
          echo "Security profiles active:"
          echo "  - Seccomp: Custom blacklist (50+ dangerous syscalls blocked)"
          echo "  - AppArmor: secdev-app (custom MAC policy)"
          echo ""

          docker compose up -d

          echo ""
          echo "=== Waiting for application startup ==="
          sleep 15

          echo ""
          echo "=== Container Logs ==="
          docker compose logs

          echo ""
          echo "=== Health Check Status ==="
          docker compose ps

          echo ""
          echo "=== Verify Security Profiles ==="
          docker inspect secdev-app | jq '.[0].HostConfig.SecurityOpt'

          echo ""
          echo "=== Application Health Endpoint ==="
          for i in {1..10}; do
            if curl -f http://localhost:8000/health; then
              echo ""
              echo "✅ PASSED: Application is healthy with security profiles"
              docker compose down
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 2
          done

          echo "❌ FAILED: Application did not respond"
          docker compose logs
          docker compose down
          exit 1
